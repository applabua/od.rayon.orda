<!doctype html>
<html lang="uk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Одеський район — ЕкоЗвернення</title>
<meta name="theme-color" content="#0e3c66" />

<!-- App icons (только логотип без фона) -->
<link rel="icon" type="image/png" sizes="32x32" href="https://i.ibb.co/HpC70Kdt/svg.png">
<link rel="apple-touch-icon" href="https://i.ibb.co/HpC70Kdt/svg.png">

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest?v=4">
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --blue1:#0e3c66; --blue2:#163b5f;
    --card:#111319; --line:#1e2330;
    --text:#111; --accent:#00ffc2;
    --hh:64px; /* актуализируется JS */
    --th:18px; /* актуализируется JS */
    --shadow:0 14px 40px rgba(0,0,0,.20);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--text);background:#fff;overflow:hidden} /* без прокрутки */

  /* ===== SPLASH (лаконичный, мелкий текст) ===== */
  .splash{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;
    background:linear-gradient(180deg,var(--blue1),var(--blue2));
  }
  .splash .box{display:flex;flex-direction:column;align-items:center;gap:14px}
  .splash .logo{width:min(160px,44vw);height:min(160px,44vw)}
  .splash .logo img{width:100%;height:100%;object-fit:contain}
  .splash h1{margin:0;font-size:clamp(14px,4vw,20px);font-weight:800;color:#fff;white-space:nowrap}

  /* ===== HEADER (фикс) ===== */
  header.top{
    position:fixed;left:0;right:0;top:0;z-index:20;
    background:linear-gradient(180deg,var(--blue1),var(--blue2));
    border-bottom:1px solid rgba(255,255,255,.2);
    padding:8px 12px;display:flex;align-items:center;justify-content:space-between;gap:8px;color:#fff
  }
  .brand{display:flex;align-items:center;gap:10px}
  .brand img{height:28px}
  .brand b{font-size:14px;white-space:nowrap}
  .actions{display:flex;gap:8px}
  .btn{
    appearance:none;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:#fff;
    padding:10px 12px;border-radius:12px;font-weight:800;cursor:pointer;backdrop-filter:blur(4px)
  }
  .btn-accent{background:var(--accent);color:#062018;border-color:#00e6b0}
  .btn:active{transform:translateY(1px)}

  /* ===== HELP TITLE (ещё меньше) ===== */
  .title-help{
    position:fixed;left:0;right:0;top:calc(var(--hh));z-index:5;
    text-align:center;padding:2px 10px;
    font-size:11px;line-height:1.05;font-weight:700;color:#222;
  }

  /* ===== ЭКРАН 1: только область ===== */
  .overview{
    position:fixed;left:0;right:0;top:calc(var(--hh) + var(--th));bottom:0;
    background:#fff;
  }
  .wrap-img{position:absolute;inset:12px;display:grid;place-items:center}
  .imgbox{position:relative;width:100%;height:100%;max-width:980px;max-height:100%;margin:0 auto;
          border-radius:14px;border:1px solid #e9eef6;overflow:hidden;box-shadow:var(--shadow);background:#fff}
  .imgbox img{position:absolute;inset:0;margin:auto;max-width:100%;max-height:100%;object-fit:contain}
  .hitbox{position:absolute;inset:0;pointer-events:auto}
  .hitbox svg{width:100%;height:100%}
  .raion{
    fill:rgba(0,0,0,0.001); /* кликабельная зона */
    stroke:none; cursor:pointer; pointer-events:auto;
  }

  /* ===== ЭКРАН 2: карта района ===== */
  #map{
    position:fixed;left:0;right:0;top:calc(var(--hh) + 8px);z-index:10;
    height:calc(100svh - var(--hh) - 12px);
    height:calc(100dvh - var(--hh) - 12px);
    height:calc(100vh - var(--hh) - 12px);
    min-height:320px;
    display:none; width:100%; max-width:980px; margin:0 auto;
    border-radius:14px; overflow:hidden; box-shadow:var(--shadow); border:1px solid #e9eef6; background:#eef3fa;
  }
  #map.active{display:block}
  .leaflet-container{background:#eef3fa}
  .leaflet-control-attribution{display:none}

  /* ===== Modal ===== */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);display:none;z-index:900;align-items:center;justify-content:center}
  .modal{width:min(520px,92vw);max-height:92vh;overflow:auto;background:#111319;border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 14px 40px rgba(0,0,0,.45);color:#fff}
  .modal h3{margin:0 0 8px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  label{font-size:12px;color:#d7dde9}
  input[type="text"],textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1116;color:#fff}
  textarea{min-height:88px;resize:vertical}
  .uploader{border:1px dashed var(--line);border-radius:10px;padding:10px;background:#0f1116;text-align:center}
  .uploader input{display:none}
  .uploader img{max-width:100%;border-radius:8px;border:1px solid var(--line);margin-top:6px}
  .row{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .toast{
    position:fixed;left:50%;bottom:16px;transform:translateX(-50%);z-index:1000;
    background:#103521;color:#caffdb;border:1px solid #1d5f43;padding:10px 14px;border-radius:12px;box-shadow:0 10px 28px rgba(0,0,0,.35);display:none
  }

  @media (max-width:720px){
    .grid{grid-template-columns:1fr}
    .brand b{display:none}
  }
</style>
</head>
<body>

<!-- Splash -->
<div class="splash" id="splash">
  <div class="box">
    <div class="logo"><img src="https://i.ibb.co/HpC70Kdt/svg.png" alt="Логотип"></div>
    <h1>Одеська районна державна адміністрація</h1>
  </div>
</div>

<header class="top" id="topbar">
  <div class="brand">
    <img src="https://i.ibb.co/HpC70Kdt/svg.png" alt="">
    <b>Одеський район — ЕкоЗвернення</b>
  </div>
  <div class="actions">
    <button class="btn" id="btnMyPos">Моя геопозиція</button>
    <button class="btn btn-accent" id="btnMark">Позначити на карті</button>
  </div>
</header>

<!-- Маленький текст над картой -->
<h2 class="title-help" id="helpTitle">Натисніть на Одеський район, щоб відкрити мапу та подати звернення</h2>

<!-- ЭКРАН 1: обзор области -->
<section class="overview" id="overview">
  <div class="wrap-img">
    <div class="imgbox">
      <img src="https://upload.wikimedia.org/wikipedia/commons/b/b7/%D0%9A%D0%B0%D1%80%D1%82%D0%B0_%D1%80%D0%B0%D0%B9%D0%BE%D0%BD%D1%96%D0%B2_%D1%82%D0%B0_%D0%B3%D1%80%D0%BE%D0%BC%D0%B0%D0%B4_%D0%9E%D0%B4%D0%B5%D1%81%D1%8C%D0%BA%D0%BE%D1%97_%D0%BE%D0%B1%D0%BB%D0%B0%D1%81%D1%82%D1%96.jpg"
           alt="Одеська область — райони та громади">
      <div class="hitbox" aria-hidden="true">
        <svg viewBox="0 0 100 100" preserveAspectRatio="none">
          <polygon class="raion" id="odesaRaionPoly"
            points="72,68 69,70 66,72 62,75 58,78 55,80 51,81 47,80 44,78 41,75 38,71 36,67 36,63 37,59 40,55 43,52 47,50 51,49 55,49 59,50 62,52 65,55 67,58 70,62" />
        </svg>
      </div>
    </div>
  </div>
</section>

<!-- ЭКРАН 2: реальная интерактивная карта района -->
<div id="map"></div>

<!-- Модальне вікно -->
<div class="backdrop" id="modal">
  <div class="modal">
    <h3>Повідомити про сміттєзвалище</h3>
    <div class="grid" style="margin-top:6px">
      <div>
        <label>Координати</label>
        <input id="coords" type="text" readonly>
      </div>
      <div>
        <label>Населений пункт (необов'язково)</label>
        <input id="place" type="text" placeholder="Таїрове / Авангард / Доброслав …">
      </div>
      <div style="grid-column:1/-1">
        <label>Коментар</label>
        <textarea id="comment" placeholder="Опишіть місце, орієнтири, обсяг відходів тощо."></textarea>
      </div>
      <div style="grid-column:1/-1">
        <label>Фото</label>
        <div class="uploader">
          <label for="photoInput" style="cursor:pointer"><span style="border:1px solid var(--line);padding:4px 8px;border-radius:999px;">Додати фото</span></label>
          <input id="photoInput" type="file" accept="image/*" capture="environment">
          <div id="photoPreview"></div>
        </div>
        <div style="color:#93a1b4;margin-top:6px">Фото стискається до ~1024px і зберігається лише у вашому браузері.</div>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="btnCancel">Скасувати</button>
      <button class="btn btn-accent" id="btnSend">Підтвердити та надіслати</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Звернення надіслано (локально збережено)</div>

<script>
/* ===== PWA ===== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
}

/* ===== Splash короткий ===== */
setTimeout(()=>{ const s=document.getElementById('splash'); if(s) s.style.display='none'; }, 3000);

/* ===== высоты (фикс-экраны) ===== */
function setHeights(){
  const hh = document.getElementById('topbar').offsetHeight || 60;
  const th = document.getElementById('helpTitle').offsetHeight || 0;
  document.documentElement.style.setProperty('--hh', hh+'px');
  document.documentElement.style.setProperty('--th', th+'px');
}
window.addEventListener('load', setHeights);
window.addEventListener('resize', setHeights);

/* ===== Экраны ===== */
const overview = document.getElementById('overview');
const helpTitle = document.getElementById('helpTitle');
const mapEl = document.getElementById('map');

function toMapView() {
  overview.style.display='none';
  helpTitle.style.display='none';
  mapEl.classList.add('active');
  setHeights();           // пересчёт высот сразу при показе карты
  initMapOnce();
  setTimeout(()=>{ if(map){ map.invalidateSize(); } }, 220);
  askForGeo();            // автозапрос гео при входе на карту
}
document.getElementById('odesaRaionPoly').addEventListener('click', toMapView);

/* ===== Storage ===== */
const STORE_KEY='eko_od_raion_reports';
let reports = JSON.parse(localStorage.getItem(STORE_KEY)||'[]');
const persist = () => localStorage.setItem(STORE_KEY, JSON.stringify(reports));

/* ===== Leaflet map (увеличенный район) ===== */
let map, markers=new Map(), addMode=false, staged=null, inited=false;
let bounds, TrashIcon;

// Контур району (грубая аппроксимация)
const ODESA_RAION_POLY = [
  [46.705, 30.280], [46.790, 30.430], [46.865, 30.650], [46.925, 30.900],
  [46.920, 31.150], [46.820, 31.250], [46.700, 31.300], [46.560, 31.250],
  [46.470, 31.120], [46.420, 30.960], [46.380, 30.800], [46.330, 30.640],
  [46.280, 30.520], [46.300, 30.360], [46.380, 30.280], [46.520, 30.240],
  [46.620, 30.240], [46.680, 30.250], [46.705, 30.280]
];

// Ждём, пока Leaflet загрузится (скрипт с defer)
function leafletReady(){
  return new Promise(resolve=>{
    if (window.L) return resolve();
    const t = setInterval(()=>{
      if (window.L){ clearInterval(t); resolve(); }
    }, 30);
    // запасной таймаут — почти не нужен, но чтоб не зависнуть
    setTimeout(()=>{ clearInterval(t); resolve(); }, 5000);
  });
}

async function initMapOnce(){
  if(inited) return;
  await leafletReady();       // гарантия наличия window.L

  // вычисляем границы только теперь, когда L есть
  bounds = L.latLngBounds(ODESA_RAION_POLY.map(p=>[p[0],p[1]]));

  TrashIcon = L.divIcon({
    className:'trash-pin',
    html:`<div style="width:22px;height:22px;border-radius:50%;background:#0f1116;border:2px solid ${getComputedStyle(document.documentElement).getPropertyValue('--accent')};
      display:flex;align-items:center;justify-content:center;box-shadow:0 6px 14px rgba(0,0,0,.4)">
        <svg viewBox="0 0 24 24" width="12" height="12" fill="none">
          <path d="M8 6h8l-1 14H9L8 6z" stroke="#00ffc2" stroke-width="1.6"/>
          <path d="M6 6h12M10 6V4h4v2" stroke="#00ffc2" stroke-width="1.6"/>
        </svg>
      </div>`,
    iconSize:[22,22], iconAnchor:[11,22], popupAnchor:[0,-18]
  });

  map = L.map('map', {
    zoomControl:true, minZoom:10, maxZoom:18,
    maxBounds: bounds.pad(0.05), maxBoundsViscosity:1.0
  }).fitBounds(bounds);

  const base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { attribution:'© OpenStreetMap', detectRetina:true, updateWhenIdle:true, updateWhenZooming:false });
  base.on('tileerror', ()=> toast('Не вдалося завантажити тайли мапи. Перевірте інтернет.'));
  base.addTo(map);

  L.polygon(ODESA_RAION_POLY, {color:'#2b2f3a', weight:1.2, fill:true, fillColor:'#0f1116', fillOpacity:.18}).addTo(map);

  // маска за пределами району (не перехватывает клики)
  (function mask(){
    const world=[[-90,-180],[-90,180],[90,180],[90,-180]];
    L.polygon([world, ODESA_RAION_POLY], {color:'#000',weight:0,fill:true,fillColor:'#000',fillOpacity:.22,interactive:false}).addTo(map);
  })();

  map.on('click', e=>{
    if(!bounds.contains(e.latlng)) return;
    if(addMode) openModal(e.latlng);
  });

  // поднять из localStorage
  reports.forEach(addMarker);

  // на всякий случай
  setTimeout(()=>{ map.invalidateSize(); }, 500);
  window.addEventListener('orientationchange', ()=> setTimeout(()=>map.invalidateSize(), 300));

  inited = true;
}

/* Маркеры */
function addMarker(rep){
  const m = L.marker(rep.coords, {icon: TrashIcon}).addTo(map);
  const img = rep.photo ? `<img src="${rep.photo}" style="max-width:220px;border-radius:10px;border:1px solid #1e2330;margin-top:6px">` : '';
  m.bindPopup(`
    <h5>Несанкціоноване сміттєзвалище</h5>
    <div style="font-size:12px;color:#6f7b8c">ID: <b>${rep.id}</b> · ${rep.time}</div>
    <div><b>Координати:</b> ${rep.coords[0].toFixed(5)}, ${rep.coords[1].toFixed(5)}</div>
    ${rep.place?`<div><b>Нас. пункт:</b> ${rep.place}</div>`:''}
    ${rep.comment?`<div style="margin-top:6px">${rep.comment.replace(/</g,'&lt;')}</div>`:''}
    ${img}
  `);
  markers.set(rep.id, m);
}

/* Утилита: показать карту перед действием */
function ensureMapThen(fn){
  if(!mapEl.classList.contains('active')) toMapView();
  setTimeout(fn, 150);
}

/* Геопозиция: при входе на карту и по кнопке — запрос и выделение точки */
function askForGeo(){
  if(!navigator.geolocation) { return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const latlng = L.latLng(pos.coords.latitude, pos.coords.longitude);
    if(!bounds.contains(latlng)){
      toast('Ви поза межами району. Оберіть точку на мапі.');
      map.fitBounds(bounds);
      return;
    }
    map.setView(latlng, 16);
    openModal(latlng); // сразу предлагаем підтвердити звернення
  }, ()=>{
    // користувач міг відхилити — без тосту
  }, {enableHighAccuracy:true, timeout:9000, maximumAge:0});
}

/* Кнопки */
document.getElementById('btnMyPos').onclick = ()=> ensureMapThen(()=> askForGeo());
document.getElementById('btnMark').onclick = ()=> ensureMapThen(()=>{
  addMode = true;
  toast('Режим позначення: торкніться мапи, щоб вибрати точку');
});

/* ===== Modal ===== */
const modal = document.getElementById('modal');
function openModal(latlng){
  staged = [latlng.lat, latlng.lng];
  document.getElementById('coords').value = `${staged[0].toFixed(6)}, ${staged[1].toFixed(6)}`;
  modal.style.display='flex';
}
function closeModal(){
  modal.style.display='none'; staged=null; addMode=false;
  document.getElementById('place').value='';
  document.getElementById('comment').value='';
  document.getElementById('coords').value='';
  document.getElementById('photoInput').value='';
  document.getElementById('photoPreview').innerHTML='';
}
document.getElementById('btnCancel').onclick = closeModal;
modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });

/* Фото → сжатие до ~1024px */
document.getElementById('photoInput').addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const img=new Image(); const r=new FileReader();
  r.onload=()=>{ img.onload=()=>{
      const max=1024, k=Math.min(1, max/Math.max(img.width,img.height));
      const c=document.createElement('canvas'); c.width=img.width*k; c.height=img.height*k;
      c.getContext('2d').drawImage(img,0,0,c.width,c.height);
      const data=c.toDataURL('image/jpeg',0.85);
      document.getElementById('photoPreview').innerHTML=`<img src="${data}" alt="Фото">`;
  }; img.src=r.result; }; r.readAsDataURL(f);
});

/* Отправка */
document.getElementById('btnSend').onclick = ()=>{
  if(!staged){ toast('Вкажіть точку на мапі.'); return; }
  const place = document.getElementById('place').value.trim();
  const comment = document.getElementById('comment').value.trim();
  const photo = document.querySelector('#photoPreview img')?.src || null;
  const rep = { id:'R'+Math.random().toString(36).slice(2,8).toUpperCase(), time:ts(), coords:staged, place, comment, photo };
  reports.push(rep); persist(); addMarker(rep);
  closeModal(); toast('Звернення надіслано · додано на мапу');
};

function ts(){ const d=new Date(); const p=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; }

/* Toast */
let toastTimer=null;
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.display='block'; t.style.opacity='1';
  clearTimeout(toastTimer); toastTimer=setTimeout(()=>{ t.style.opacity='0'; t.style.display='none'; }, 2400);
}
</script>
</body>
</html>
